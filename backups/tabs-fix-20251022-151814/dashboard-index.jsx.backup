import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Header from '../../components/ui/Header';
import Icon from '../../components/AppIcon';
import Button from '../../components/ui/Button';
import { useAuth } from '../../contexts/AuthContext';
import ChatSystem from '../../components/ChatSystem';
import NotificationSystem from '../../components/NotificationSystem';
import ServiceManagement from './components/ServiceManagement';
import BookingManagement from './components/BookingManagement';
import BusinessAnalytics from './components/BusinessAnalytics';
import BusinessProfile from './components/BusinessProfile';
import ServicePromotion from './components/ServicePromotion';
import AccountVerification from './components/AccountVerification';
import TravelerStoriesView from './components/TravelerStoriesView';

const ServiceProviderDashboard = () => {
  const [activeTab, setActiveTab] = useState('overview');
  const [showCustomerChat, setShowCustomerChat] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [myServices, setMyServices] = useState([]);
  const [myBookings, setMyBookings] = useState([]);
  const [stats, setStats] = useState({ totalServices: 0, activeBookings: 0, monthlyEarnings: 0, customerRating: 0 });
  const [loadingServices, setLoadingServices] = useState(true);
  const [loadingBookings, setLoadingBookings] = useState(false);
  const { user, logout, isLoading} = useAuth();
  const navigate = useNavigate();

  console.log('Service Provider Dashboard - activeTab:', activeTab);
  console.log('Service Provider Dashboard - user:', user);

  // Redirect to login if not authenticated
  useEffect(() => {
    if (!isLoading && !user) {
      navigate('/login');
    }
  }, [user, isLoading, navigate]);

  // Fetch real services and bookings
  useEffect(() => {
    if (user?.id) {
      fetchMyServices();
      fetchMyBookings();
    }
  }, [user]);

  const fetchMyServices = async () => {
    try {
      setLoadingServices(true);
      const userData = JSON.parse(localStorage.getItem('isafari_user') || '{}');
      const token = userData.token;

      if (!token) return;

      const response = await fetch('/api/services/provider/my-services', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        console.error('Invalid response content type');
        return;
      }

      const text = await response.text();
      if (!text) {
        console.error('Empty response from server');
        return;
      }

      const data = JSON.parse(text);
      
      if (data.success && data.services) {
        setMyServices(data.services);
        
        // Calculate real stats
        const totalServices = data.services.length;
        const activeServices = data.services.filter(s => s.is_active).length;
        const totalBookings = data.services.reduce((sum, s) => sum + (s.total_bookings || 0), 0);
        const avgRating = data.services.reduce((sum, s) => sum + parseFloat(s.average_rating || 0), 0) / (totalServices || 1);
        
        setStats({
          totalServices: activeServices,
          activeBookings: totalBookings,
          monthlyEarnings: 0, // Will be calculated from bookings
          customerRating: avgRating.toFixed(1)
        });
      }
    } catch (error) {
      console.error('Error fetching services:', error);
    } finally {
      setLoadingServices(false);
    }
  };

  const fetchMyBookings = async () => {
    try {
      setLoadingBookings(true);
      const userData = JSON.parse(localStorage.getItem('isafari_user') || '{}');
      const token = userData.token;

      console.log('üîç Fetching bookings for service provider...');

      if (!token) {
        console.error('‚ùå No token found');
        return;
      }

      const response = await fetch('/api/bookings', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log('üì° Response status:', response.status);

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        console.error('‚ùå Invalid response content type:', contentType);
        return;
      }

      const text = await response.text();
      if (!text) {
        console.error('‚ùå Empty response from server');
        return;
      }

      const data = JSON.parse(text);
      console.log('üì¶ Bookings data received:', data);
      
      if (data.success && data.bookings) {
        console.log('‚úÖ Bookings count:', data.bookings.length);
        console.log('üìã Bookings:', data.bookings);
        setMyBookings(data.bookings);
      } else {
        console.error('‚ùå Failed to fetch bookings:', data.message);
      }
    } catch (error) {
      console.error('‚ùå Error fetching bookings:', error);
    } finally {
      setLoadingBookings(false);
    }
  };

  const updateBookingStatus = async (bookingId, newStatus) => {
    try {
      const userData = JSON.parse(localStorage.getItem('isafari_user') || '{}');
      const token = userData.token;

      if (!token) {
        alert('Please login to update booking status');
        return;
      }

      const response = await fetch(`/api/bookings/${bookingId}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ status: newStatus })
      });

      const data = await response.json();
      
      if (data.success) {
        alert(`Booking ${newStatus} successfully!`);
        fetchMyBookings(); // Refresh bookings list
        return true;
      } else {
        alert('Error: ' + data.message);
        return false;
      }
    } catch (error) {
      console.error('Error updating booking status:', error);
      alert('Error updating booking. Please try again.');
      return false;
    }
  };

  const deleteBooking = async (bookingId) => {
    try {
      const userData = JSON.parse(localStorage.getItem('isafari_user') || '{}');
      const token = userData.token;

      if (!token) {
        alert('Please login to delete booking');
        return;
      }

      console.log('üóëÔ∏è  Deleting booking:', bookingId);

      const response = await fetch(`/api/bookings/${bookingId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const data = await response.json();
      
      if (data.success) {
        alert('Pre-order deleted successfully!');
        fetchMyBookings(); // Refresh bookings list
        return true;
      } else {
        alert('Error: ' + data.message);
        return false;
      }
    } catch (error) {
      console.error('Error deleting booking:', error);
      alert('Error deleting booking. Please try again.');
      return false;
    }
  };

  // Show loading while checking authentication
  if (isLoading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-center">
          <Icon name="Loader2" size={48} className="animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Loading your dashboard...</p>
        </div>
      </div>
    );
  }

  // Return null while redirecting
  if (!user) {
    return null;
  }

  const tabs = [
    { id: 'overview', name: 'Overview', icon: 'LayoutDashboard' },
    { id: 'services', name: 'My Services', icon: 'Package' },
    { id: 'bookings', name: 'Bookings', icon: 'Calendar' },
    { id: 'stories', name: 'Traveler Stories', icon: 'BookOpen' },
    { id: 'promotion', name: 'Promote Services', icon: 'TrendingUp' },
    { id: 'verification', name: 'Get Verified', icon: 'Shield' },
    { id: 'analytics', name: 'Analytics', icon: 'BarChart' },
    { id: 'profile', name: 'My Profile', icon: 'User' },
    { id: 'earnings', name: 'Earnings', icon: 'DollarSign' }
  ];

  // Stats are now calculated from real data in fetchMyServices

  const notifications = [
    {
      id: 1,
      type: 'booking',
      title: 'New Booking Request',
      message: 'John Doe wants to book your Safari Package',
      time: '2 hours ago',
      urgent: true
    },
    {
      id: 2,
      type: 'review',
      title: 'New Review',
      message: 'Sarah left a 5-star review for your service',
      time: '4 hours ago',
      urgent: false
    },
    {
      id: 3,
      type: 'payment',
      title: 'Payment Received',
      message: 'Payment of $250 received for Kilimanjaro Trek',
      time: '1 day ago',
      urgent: false
    }
  ];

  const showNotificationsModal = () => {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    `;
    
    modalContent.innerHTML = `
      <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px;">
        <h1 style="color: #1f2937; font-size: 28px; font-weight: 600; margin: 0 0 8px 0;">üîî All Notifications</h1>
        <p style="color: #6b7280; font-size: 16px; margin: 0;">Stay updated with your service provider activities</p>
      </div>
      
      <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #dc2626; background: #fef2f2;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <h3 style="font-weight: 600; color: #374151; margin: 0;">New Booking Request</h3>
          <span style="font-size: 12px; color: #6b7280;">2 hours ago</span>
        </div>
        <p style="color: #4b5563; margin: 0; line-height: 1.5;">John Doe wants to book your Safari Package for December 15-18. Please review and respond within 24 hours.</p>
        <button style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 10px;" onclick="this.style.background='#dcfce7'; this.textContent='‚úì Marked as Read';">Mark as Read</button>
      </div>
      
      <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #16a34a; background: #f0fdf4;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <h3 style="font-weight: 600; color: #374151; margin: 0;">New Review Received</h3>
          <span style="font-size: 12px; color: #6b7280;">4 hours ago</span>
        </div>
        <p style="color: #4b5563; margin: 0; line-height: 1.5;">Sarah Johnson left a 5-star review: "Amazing safari experience! Highly recommend this provider."</p>
        <button style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 10px;" onclick="this.style.background='#dcfce7'; this.textContent='‚úì Marked as Read';">Mark as Read</button>
      </div>
      
      <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #2563eb; background: #eff6ff;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <h3 style="font-weight: 600; color: #374151; margin: 0;">Payment Received</h3>
          <span style="font-size: 12px; color: #6b7280;">1 day ago</span>
        </div>
        <p style="color: #4b5563; margin: 0; line-height: 1.5;">Payment of $250 received for Kilimanjaro Trek booking. Funds will be available in 2-3 business days.</p>
        <button style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 10px;" onclick="this.style.background='#dcfce7'; this.textContent='‚úì Marked as Read';">Mark as Read</button>
      </div>
      
      <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #f59e0b; background: #fffbeb;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
          <h3 style="font-weight: 600; color: #374151; margin: 0;">Profile Update Required</h3>
          <span style="font-size: 12px; color: #6b7280;">2 days ago</span>
        </div>
        <p style="color: #4b5563; margin: 0; line-height: 1.5;">Please update your service availability calendar to avoid booking conflicts during peak season.</p>
        <button style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 10px;" onclick="this.style.background='#dcfce7'; this.textContent='‚úì Marked as Read';">Mark as Read</button>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px;">
        <button style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;" onclick="document.querySelectorAll('button').forEach(btn => { if (btn.textContent === 'Mark as Read') { btn.style.background='#dcfce7'; btn.textContent='‚úì Marked as Read'; } }); alert('‚úÖ All notifications marked as read!');">Mark All Read</button>
        <button style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #6b7280; color: white;" onclick="document.body.removeChild(document.querySelector('[style*=\"z-index: 9999\"]'));">Close</button>
      </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Close modal when clicking overlay
    modalOverlay.addEventListener('click', (event) => {
      if (event.target === modalOverlay) {
        document.body.removeChild(modalOverlay);
      }
    });
  };


  const mockServices = [
    {
      id: 1,
      name: "Budget Safari Package",
      category: "Tours & Activities",
      price: 150,
      status: "active",
      bookings: 25,
      rating: 4.6
    },
    {
      id: 2,
      name: "Community Hiking Guide",
      category: "Adventure Sports",
      price: 25,
      status: "active",
      bookings: 18,
      rating: 4.8
    },
    {
      id: 3,
      name: "Hostel Accommodation",
      category: "Budget Stay",
      price: 15,
      status: "active",
      bookings: 45,
      rating: 4.3
    },
    {
      id: 4,
      name: "Local Food Tour",
      category: "Cultural Experience",
      price: 30,
      status: "active",
      bookings: 32,
      rating: 4.9
    },
    {
      id: 5,
      name: "Premium Safari Experience",
      category: "Luxury Tours",
      price: 850,
      status: "active",
      bookings: 8,
      rating: 4.9
    }
  ];

  const renderTabContent = () => {
    switch (activeTab) {
      case 'overview':
        return (
          <div className="space-y-8">
            {/* Welcome Section */}
            <div className="bg-gradient-to-r from-primary to-secondary rounded-xl p-6 text-white">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="font-display text-2xl font-medium mb-2">Welcome, {user?.firstName || 'Service Provider'}!</h2>
                  <p className="text-white/90">Manage your services and grow your business with iSafari Global</p>
                </div>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Icon name="Package" size={20} className="text-primary" />
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-foreground">{stats.totalServices}</p>
                    <p className="text-sm text-muted-foreground">Active Services</p>
                  </div>
                </div>
              </div>

              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center">
                    <Icon name="Calendar" size={20} className="text-secondary" />
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-foreground">{stats.activeBookings}</p>
                    <p className="text-sm text-muted-foreground">Total Bookings</p>
                  </div>
                </div>
              </div>

              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center">
                    <Icon name="DollarSign" size={20} className="text-accent" />
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-foreground">{myServices.length}</p>
                    <p className="text-sm text-muted-foreground">Total Services</p>
                  </div>
                </div>
              </div>

              <div className="bg-card border border-border rounded-lg p-4">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-success/10 rounded-lg flex items-center justify-center">
                    <Icon name="Star" size={20} className="text-success" />
                  </div>
                  <div>
                    <p className="text-2xl font-bold text-foreground">{stats.customerRating || '0.0'}</p>
                    <p className="text-sm text-muted-foreground">Avg Rating</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Recent Services */}
            <div>
              <div className="flex items-center justify-between mb-6">
                <h3 className="font-display text-xl font-medium">Your Services</h3>
                <Button variant="default" onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setActiveTab('services');
                }}>
                  <Icon name="Plus" size={16} />
                  Add New Service
                </Button>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {loadingServices ? (
                  <div className="col-span-2 flex items-center justify-center py-12">
                    <Icon name="Loader2" size={32} className="animate-spin text-primary" />
                  </div>
                ) : myServices.length > 0 ? (
                  myServices.map(service => (
                    <div key={service.id} className="bg-card border border-border rounded-lg p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div>
                          <h4 className="font-medium text-foreground">{service.title}</h4>
                          <p className="text-sm text-muted-foreground">{service.category || 'Uncategorized'}</p>
                        </div>
                        <span className={`px-2 py-1 rounded-full text-xs ${
                          service.is_active 
                            ? 'bg-success/10 text-success' 
                            : 'bg-muted text-muted-foreground'
                        }`}>
                          {service.is_active ? 'active' : 'inactive'}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                          <span className="text-lg font-bold text-foreground">TZS {parseFloat(service.price || 0).toLocaleString()}</span>
                          <div className="flex items-center space-x-1">
                            <Icon name="Star" size={14} className="text-yellow-500" />
                            <span className="text-sm text-muted-foreground">{parseFloat(service.average_rating || 0).toFixed(1)}</span>
                          </div>
                        </div>
                        <span className="text-sm text-muted-foreground">{service.total_bookings || 0} bookings</span>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="col-span-2 text-center py-12">
                    <Icon name="Package" size={48} className="mx-auto text-muted-foreground mb-4" />
                    <p className="text-muted-foreground mb-4">You haven't added any services yet</p>
                    <Button onClick={() => setActiveTab('services')}>
                      <Icon name="Plus" size={16} />
                      Add Your First Service
                    </Button>
                  </div>
                )}
              </div>
            </div>
          </div>
        );

      case 'services':
        return <ServiceManagement />;

      case 'bookings':
        return <BookingManagement bookings={myBookings} onUpdateBookingStatus={updateBookingStatus} onDeleteBooking={deleteBooking} loading={loadingBookings} />;

      case 'stories':
        return <TravelerStoriesView />;

      case 'analytics':
        return <BusinessAnalytics />;

      case 'promotion':
        return <ServicePromotion />;

      case 'verification':
        return <AccountVerification />;

      case 'profile':
        return <BusinessProfile />;

      case 'earnings':
        return (
          <div className="space-y-8">
            <h2 className="font-display text-2xl font-medium">Earnings & Payouts</h2>
            <div className="bg-card border border-border rounded-lg p-6">
              <p className="text-muted-foreground">Earnings management will be implemented here.</p>
            </div>
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Header />
      <div className="pt-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Tab Navigation */}
          <div className="flex justify-between items-center mb-8 border-b border-border">
            <div className="flex flex-wrap gap-2">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    setActiveTab(tab.id);
                  }}
                  className={`flex items-center space-x-2 px-4 py-3 rounded-t-lg text-sm font-medium transition-all duration-200 ${
                    activeTab === tab.id
                      ? 'bg-primary text-primary-foreground border-b-2 border-primary'
                      : 'text-muted-foreground hover:text-foreground hover:bg-muted'
                  }`}
                >
                  <Icon name={tab.icon} size={16} />
                  <span>{tab.name}</span>
                </button>
              ))}
            </div>
            
            {/* User Profile Section */}
            <div className="flex items-center space-x-3">
              <img 
                src={user?.avatar || `https://ui-avatars.com/api/?name=${user?.firstName || 'Provider'}&background=0D8ABC&color=fff`} 
                alt="Profile" 
                className="w-8 h-8 rounded-full"
              />
              <span className="text-sm font-medium text-foreground">{user?.firstName || 'Provider'} {user?.lastName || ''}</span>
              <Button
                variant="outline"
                size="sm"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  if (confirm('Are you sure you want to sign out?')) {
                    logout();
                  }
                }}
                className="ml-4"
              >
                <Icon name="LogOut" size={16} />
                Sign Out
              </Button>
            </div>
          </div>

          {/* Main Content with Sidebar */}
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
            {/* Main Content */}
            <div className="lg:col-span-3">
              {renderTabContent()}
            </div>

            {/* Sidebar */}
            <div className="space-y-6">

              {/* Recent Notifications */}
              <div className="bg-card border border-border rounded-lg p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-foreground">Recent Notifications</h3>
                  <Button variant="ghost" size="sm">
                    <Icon name="MoreHorizontal" size={16} />
                  </Button>
                </div>
                <div className="space-y-4">
                  {notifications?.slice(0, 3).map((notification) => (
                    <div key={notification?.id} className="flex items-start space-x-3">
                      <div className={`p-2 rounded-lg ${notification?.urgent ? 'bg-error/10' : 'bg-primary/10'}`}>
                        <Icon 
                          name={notification?.type === 'booking' ? 'Calendar' : notification?.type === 'review' ? 'Star' : 'Bell'} 
                          size={16} 
                          className={notification?.urgent ? 'text-error' : 'text-primary'} 
                        />
                      </div>
                      <div className="flex-1 min-w-0">
                        <h4 className="text-sm font-medium text-foreground">{notification?.title}</h4>
                        <p className="text-xs text-muted-foreground mt-1">{notification?.message}</p>
                        <p className="text-xs text-muted-foreground mt-1">{notification?.time}</p>
                      </div>
                    </div>
                  ))}
                </div>
                <Button variant="outline" size="sm" fullWidth className="mt-4" onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  showNotificationsModal();
                }}>
                  View All Notifications
                </Button>
              </div>

              {/* Help & Resources */}
              <div className="bg-card border border-border rounded-lg p-6">
                <h3 className="text-lg font-semibold text-foreground mb-4">Help & Resources</h3>
                <div className="space-y-3">
                  <button onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const guideWindow = window.open('', '_blank', 'width=900,height=700');
                    guideWindow.document.write(`
                      <html>
                        <head>
                          <title>Service Provider Guide - iSafari Global</title>
                          <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
                            .container { background: white; padding: 40px; border-radius: 12px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
                            .header { border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px; }
                            .title { color: #1f2937; font-size: 28px; font-weight: 600; margin: 0 0 8px 0; }
                            .subtitle { color: #6b7280; font-size: 16px; margin: 0; }
                            .section { margin: 30px 0; }
                            .section-title { color: #374151; font-size: 20px; font-weight: 600; margin: 0 0 15px 0; }
                            .guide-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin: 15px 0; }
                            .guide-item h4 { color: #1f2937; margin: 0 0 10px 0; }
                            .guide-item p { color: #4b5563; margin: 0; line-height: 1.6; }
                            .buttons { display: flex; gap: 12px; justify-content: center; margin-top: 30px; }
                            .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
                            .btn-primary { background: #3b82f6; color: white; }
                            .btn-primary:hover { background: #2563eb; }
                            .btn-secondary { background: #6b7280; color: white; }
                            .btn-secondary:hover { background: #4b5563; }
                          </style>
                        </head>
                        <body>
                          <div class="container">
                            <div class="header">
                              <h1 class="title">üìñ Service Provider Guide</h1>
                              <p class="subtitle">Everything you need to know about being a successful service provider</p>
                            </div>
                            <div class="section">
                              <h2 class="section-title">üöÄ Getting Started</h2>
                              <div class="guide-item">
                                <h4>Setting Up Your Profile</h4>
                                <p>Complete your profile with high-quality photos, detailed descriptions, and accurate pricing to attract more customers.</p>
                              </div>
                              <div class="guide-item">
                                <h4>Managing Availability</h4>
                                <p>Keep your calendar updated to avoid booking conflicts and ensure smooth customer experience.</p>
                              </div>
                            </div>
                            <div class="section">
                              <h2 class="section-title">üíº Best Practices</h2>
                              <div class="guide-item">
                                <h4>Customer Communication</h4>
                                <p>Respond to inquiries within 24 hours and maintain professional communication throughout the booking process.</p>
                              </div>
                              <div class="guide-item">
                                <h4>Quality Service Delivery</h4>
                                <p>Exceed customer expectations by providing detailed itineraries, safety briefings, and memorable experiences.</p>
                              </div>
                            </div>
                            <div class="buttons">
                              <button class="btn btn-secondary" onclick="window.close()">‚úï Close</button>
                            </div>
                          </div>
                        </body>
                      </html>
                    `);
                  }} className="w-full flex items-center space-x-3 p-3 text-left rounded-lg hover:bg-muted transition-colors">
                    <div className="p-2 bg-blue-100 rounded-lg">
                      <Icon name="BookOpen" size={16} className="text-blue-600" />
                    </div>
                    <span className="text-sm font-medium text-foreground">Provider Guide</span>
                  </button>

                  <button onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const tutorialsWindow = window.open('', '_blank', 'width=900,height=700');
                    tutorialsWindow.document.write(`
                      <html>
                        <head>
                          <title>Video Tutorials - iSafari Global</title>
                          <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
                            .container { background: white; padding: 40px; border-radius: 12px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
                            .header { border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px; }
                            .title { color: #1f2937; font-size: 28px; font-weight: 600; margin: 0 0 8px 0; }
                            .subtitle { color: #6b7280; font-size: 16px; margin: 0; }
                            .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
                            .video-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s; }
                            .video-card:hover { border-color: #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                            .video-thumbnail { width: 100%; height: 150px; background: #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
                            .play-icon { font-size: 48px; color: #3b82f6; }
                            .video-title { color: #1f2937; font-weight: 600; margin: 0 0 8px 0; }
                            .video-description { color: #6b7280; font-size: 14px; margin: 0; }
                            .buttons { display: flex; gap: 12px; justify-content: center; margin-top: 30px; }
                            .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
                            .btn-secondary { background: #6b7280; color: white; }
                            .btn-secondary:hover { background: #4b5563; }
                          </style>
                        </head>
                        <body>
                          <div class="container">
                            <div class="header">
                              <h1 class="title">üé• Video Tutorials</h1>
                              <p class="subtitle">Learn how to maximize your success as a service provider</p>
                            </div>
                            <div class="video-grid">
                              <div class="video-card">
                                <div class="video-thumbnail">
                                  <div class="play-icon">‚ñ∂Ô∏è</div>
                                </div>
                                <h3 class="video-title">Getting Started Guide</h3>
                                <p class="video-description">Learn the basics of setting up your service provider account and creating your first listing.</p>
                              </div>
                              <div class="video-card">
                                <div class="video-thumbnail">
                                  <div class="play-icon">‚ñ∂Ô∏è</div>
                                </div>
                                <h3 class="video-title">Photography Tips</h3>
                                <p class="video-description">How to take stunning photos that will attract more customers to your services.</p>
                              </div>
                              <div class="video-card">
                                <div class="video-thumbnail">
                                  <div class="play-icon">‚ñ∂Ô∏è</div>
                                </div>
                                <h3 class="video-title">Pricing Strategies</h3>
                                <p class="video-description">Set competitive prices that maximize your earnings while staying attractive to customers.</p>
                              </div>
                              <div class="video-card">
                                <div class="video-thumbnail">
                                  <div class="play-icon">‚ñ∂Ô∏è</div>
                                </div>
                                <h3 class="video-title">Customer Service Excellence</h3>
                                <p class="video-description">Best practices for communicating with customers and delivering exceptional experiences.</p>
                              </div>
                            </div>
                            <div class="buttons">
                              <button class="btn btn-secondary" onclick="window.close()">‚úï Close</button>
                            </div>
                          </div>
                        </body>
                      </html>
                    `);
                  }} className="w-full flex items-center space-x-3 p-3 text-left rounded-lg hover:bg-muted transition-colors">
                    <div className="p-2 bg-purple-100 rounded-lg">
                      <Icon name="Play" size={16} className="text-purple-600" />
                    </div>
                    <span className="text-sm font-medium text-foreground">Video Tutorials</span>
                  </button>

                  <button onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const supportWindow = window.open('', '_blank', 'width=700,height=600');
                    supportWindow.document.write(`
                      <html>
                        <head>
                          <title>Contact Support - iSafari Global</title>
                          <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
                            .container { background: white; padding: 40px; border-radius: 12px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
                            .header { border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px; }
                            .title { color: #1f2937; font-size: 28px; font-weight: 600; margin: 0 0 8px 0; }
                            .subtitle { color: #6b7280; font-size: 16px; margin: 0; }
                            .form-group { margin-bottom: 20px; }
                            .label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
                            .input, .textarea, .select { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; }
                            .textarea { min-height: 120px; resize: vertical; }
                            .buttons { display: flex; gap: 12px; margin-top: 30px; }
                            .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex: 1; }
                            .btn-primary { background: #3b82f6; color: white; }
                            .btn-primary:hover { background: #2563eb; }
                            .btn-secondary { background: #6b7280; color: white; }
                            .btn-secondary:hover { background: #4b5563; }
                          </style>
                        </head>
                        <body>
                          <div class="container">
                            <div class="header">
                              <h1 class="title">üìû Contact Support</h1>
                              <p class="subtitle">Get help from our dedicated support team</p>
                            </div>
                            <form>
                              <div class="form-group">
                                <label class="label">Subject</label>
                                <select class="select">
                                  <option>General Inquiry</option>
                                  <option>Technical Issue</option>
                                  <option>Billing Question</option>
                                  <option>Account Problem</option>
                                  <option>Feature Request</option>
                                </select>
                              </div>
                              <div class="form-group">
                                <label class="label">Your Name</label>
                                <input type="text" class="input" placeholder="Enter your full name">
                              </div>
                              <div class="form-group">
                                <label class="label">Email Address</label>
                                <input type="email" class="input" placeholder="Enter your email address">
                              </div>
                              <div class="form-group">
                                <label class="label">Message</label>
                                <textarea class="textarea" placeholder="Describe your issue or question in detail..."></textarea>
                              </div>
                              <div class="buttons">
                                <button type="button" class="btn btn-primary" onclick="alert('‚úÖ Support ticket submitted! We will respond within 24 hours.'); window.close();">üìß Send Message</button>
                                <button type="button" class="btn btn-secondary" onclick="window.close()">‚úï Cancel</button>
                              </div>
                            </form>
                          </div>
                        </body>
                      </html>
                    `);
                  }} className="w-full flex items-center space-x-3 p-3 text-left rounded-lg hover:bg-muted transition-colors">
                    <div className="p-2 bg-green-100 rounded-lg">
                      <Icon name="MessageCircle" size={16} className="text-green-600" />
                    </div>
                    <span className="text-sm font-medium text-foreground">Contact Support</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Floating Action Buttons */}
      <div className="fixed bottom-6 right-6 flex flex-col space-y-3 z-40">
        
        {/* Customer Messages Button */}
        <Button
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            setSelectedCustomer({ id: 1, name: 'John Doe' });
            setShowCustomerChat(true);
          }}
          className="w-14 h-14 rounded-full bg-green-600 hover:bg-green-700 shadow-lg relative"
          title="Customer Messages"
        >
          <Icon name="MessageCircle" size={24} />
          <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
            5
          </span>
        </Button>
        
        {/* Notifications Button */}
        <Button
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            const notificationsWindow = window.open('', '_blank', 'width=800,height=700');
            notificationsWindow.document.write(`
              <html>
                <head>
                  <title>All Notifications - iSafari Global</title>
                  <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
                    .container { background: white; padding: 40px; border-radius: 12px; max-width: 700px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
                    .header { border-bottom: 1px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 30px; }
                    .title { color: #1f2937; font-size: 28px; font-weight: 600; margin: 0 0 8px 0; }
                    .subtitle { color: #6b7280; font-size: 16px; margin: 0; }
                    .notification { padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 15px; transition: all 0.2s; }
                    .notification:hover { border-color: #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                    .notification.urgent { border-left: 4px solid #dc2626; background: #fef2f2; }
                    .notification.info { border-left: 4px solid #2563eb; background: #eff6ff; }
                    .notification.success { border-left: 4px solid #16a34a; background: #f0fdf4; }
                    .notification.warning { border-left: 4px solid #f59e0b; background: #fffbeb; }
                    .notification-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
                    .notification-title { font-weight: 600; color: #374151; margin: 0; }
                    .notification-time { font-size: 12px; color: #6b7280; }
                    .notification-message { color: #4b5563; margin: 0; line-height: 1.5; }
                    .mark-read-btn { background: #f3f4f6; border: 1px solid #d1d5db; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
                    .mark-read-btn:hover { background: #e5e7eb; }
                    .buttons { display: flex; gap: 12px; justify-content: center; margin-top: 30px; }
                    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
                    .btn-primary { background: #3b82f6; color: white; }
                    .btn-primary:hover { background: #2563eb; }
                    .btn-secondary { background: #6b7280; color: white; }
                    .btn-secondary:hover { background: #4b5563; }
                  </style>
                </head>
                <body>
                  <div class="container">
                    <div class="header">
                      <h1 class="title">üîî All Notifications</h1>
                      <p class="subtitle">Stay updated with your service provider activities</p>
                    </div>
                    <div class="notifications-list">
                      <div class="notification urgent">
                        <div class="notification-header">
                          <h3 class="notification-title">üî¥ New Booking Request</h3>
                          <div>
                            <span class="notification-time">2 hours ago</span>
                            <button class="mark-read-btn" onclick="markAsRead(this)">Mark Read</button>
                          </div>
                        </div>
                        <p class="notification-message">John Doe requested your Safari Adventure Package for January 15, 2025. Please respond within 24 hours.</p>
                      </div>
                      <div class="notification success">
                        <div class="notification-header">
                          <h3 class="notification-title">‚≠ê New Review Received</h3>
                          <div>
                            <span class="notification-time">4 hours ago</span>
                            <button class="mark-read-btn" onclick="markAsRead(this)">Mark Read</button>
                          </div>
                        </div>
                        <p class="notification-message">Sarah left a 5-star review: "Amazing safari experience! The guide was knowledgeable and the wildlife viewing was spectacular."</p>
                      </div>
                      <div class="notification warning">
                        <div class="notification-header">
                          <h3 class="notification-title">üí∞ Payment Received</h3>
                          <div>
                            <span class="notification-time">1 day ago</span>
                            <button class="mark-read-btn" onclick="markAsRead(this)">Mark Read</button>
                          </div>
                        </div>
                        <p class="notification-message">Payment of $250 received for Kilimanjaro Trek booking. Funds will be available in your account within 2-3 business days.</p>
                      </div>
                      <div class="notification info">
                        <div class="notification-header">
                          <h3 class="notification-title">üìö Training Module Available</h3>
                          <div>
                            <span class="notification-time">2 days ago</span>
                            <button class="mark-read-btn" onclick="markAsRead(this)">Mark Read</button>
                          </div>
                        </div>
                        <p class="notification-message">New sustainability training module is now available. Complete it to earn your eco-tourism certification.</p>
                      </div>
                      <div class="notification info">
                        <div class="notification-header">
                          <h3 class="notification-title">üéØ Marketing Tip</h3>
                          <div>
                            <span class="notification-time">3 days ago</span>
                            <button class="mark-read-btn" onclick="markAsRead(this)">Mark Read</button>
                          </div>
                        </div>
                        <p class="notification-message">Add more photos to your service listings to increase booking rates by up to 40%. Upload high-quality images showcasing your experiences.</p>
                      </div>
                    </div>
                    <div class="buttons">
                      <button class="btn btn-primary" onclick="markAllAsRead()">üìñ Mark All Read</button>
                      <button class="btn btn-secondary" onclick="window.close()">‚úï Close</button>
                    </div>
                  </div>
                  <script>
                    function markAsRead(button) {
                      const notification = button.closest('.notification');
                      notification.style.opacity = '0.6';
                      button.textContent = 'Read';
                      button.disabled = true;
                      button.style.background = '#d1fae5';
                      button.style.color = '#166534';
                    }
                    function markAllAsRead() {
                      const buttons = document.querySelectorAll('.mark-read-btn');
                      buttons.forEach(button => {
                        if (!button.disabled) markAsRead(button);
                      });
                      alert('‚úÖ All notifications marked as read!');
                    }
                  </script>
                </body>
              </html>
            `);
          }}
          className="w-14 h-14 rounded-full bg-blue-600 hover:bg-blue-700 shadow-lg relative"
          title="View Notifications"
        >
          <Icon name="Bell" size={24} />
          <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
            4
          </span>
        </Button>
      </div>

      {/* Chat and Notification Modals */}
      <ChatSystem
        isOpen={showCustomerChat}
        onClose={() => setShowCustomerChat(false)}
        chatType="customer"
        recipientId={selectedCustomer?.id}
        recipientName={selectedCustomer?.name}
      />
      
      <NotificationSystem
        isOpen={showNotifications}
        onClose={() => setShowNotifications(false)}
        userType="provider"
      />
    </div>
  );
};

export default ServiceProviderDashboard;
