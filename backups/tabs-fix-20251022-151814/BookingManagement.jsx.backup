import React, { useState } from 'react';
import Icon from '../../../components/AppIcon';
import Button from '../../../components/ui/Button';

const BookingManagement = ({ bookings = [], onUpdateBookingStatus, onDeleteBooking, loading = false }) => {
  const [activeBookingTab, setActiveBookingTab] = useState('pending');

  // Group bookings by status
  const groupedBookings = {
    pending: bookings.filter(b => b.status === 'pending'),
    confirmed: bookings.filter(b => b.status === 'confirmed'),
    completed: bookings.filter(b => b.status === 'completed'),
    cancelled: bookings.filter(b => b.status === 'cancelled')
  };

  const bookingTabs = [
    { id: 'pending', name: 'Pending Pre-Orders', count: groupedBookings.pending.length },
    { id: 'confirmed', name: 'Confirmed', count: groupedBookings.confirmed.length },
    { id: 'completed', name: 'Completed', count: groupedBookings.completed.length },
    { id: 'cancelled', name: 'Rejected', count: groupedBookings.cancelled.length }
  ];

  const handleBookingAction = async (bookingId, action) => {
    if (!confirm(`Are you sure you want to ${action} this pre-order?`)) {
      return;
    }
    
    const success = await onUpdateBookingStatus(bookingId, action);
    
    if (success) {
      // Switch to the appropriate tab based on action
      if (action === 'confirmed') {
        setActiveBookingTab('confirmed');
      } else if (action === 'cancelled') {
        setActiveBookingTab('cancelled');
      } else if (action === 'completed') {
        setActiveBookingTab('completed');
      }
    }
  };

  const handleDeleteBooking = async (bookingId) => {
    if (!confirm('Are you sure you want to delete this pre-order? This action cannot be undone.')) {
      return;
    }
    
    if (onDeleteBooking) {
      await onDeleteBooking(bookingId);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'confirmed': return 'bg-blue-100 text-blue-800';
      case 'completed': return 'bg-green-100 text-green-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const currentBookings = groupedBookings[activeBookingTab] || [];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="font-display text-xl font-medium">Pre-Order Management</h3>
        <div className="flex items-center space-x-2">
          <Button variant="outline" size="sm" onClick={() => alert('Export functionality will be implemented')}>
            <Icon name="Download" size={16} />
            Export
          </Button>
          <Button variant="outline" size="sm" onClick={() => alert('Filter functionality will be implemented')}>
            <Icon name="Filter" size={16} />
            Filter
          </Button>
        </div>
      </div>

      {/* Booking Status Tabs */}
      <div className="flex space-x-1 bg-muted p-1 rounded-lg">
        {bookingTabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveBookingTab(tab.id)}
            className={`flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 ${
              activeBookingTab === tab.id
                ? 'bg-background text-foreground shadow-sm'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            <span>{tab.name}</span>
            <span className={`px-2 py-0.5 rounded-full text-xs ${
              activeBookingTab === tab.id ? 'bg-primary text-primary-foreground' : 'bg-muted-foreground/20'
            }`}>
              {tab.count}
            </span>
          </button>
        ))}
      </div>

      {/* Bookings List */}
      <div className="space-y-4">
        {loading ? (
          <div className="text-center py-12">
            <Icon name="Loader2" size={48} className="animate-spin text-primary mx-auto mb-4" />
            <p className="text-muted-foreground">Loading pre-orders...</p>
          </div>
        ) : currentBookings.map((booking) => (
          <div key={booking.id} className="bg-card border border-border rounded-lg p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <div className="flex items-center space-x-3 mb-2">
                  <h4 className="font-medium text-foreground">
                    {`${booking.traveler_first_name || ''} ${booking.traveler_last_name || ''}`.trim() || booking.traveler?.name || 'Unknown Traveler'}
                  </h4>
                  <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(booking.status)}`}>
                    {booking.status === 'pending' ? 'üü° Pending Review' :
                     booking.status === 'confirmed' ? '‚úÖ Confirmed' :
                     booking.status === 'completed' ? '‚úÖ Completed' :
                     '‚ùå Rejected'}
                  </span>
                </div>
                <p className="text-sm text-muted-foreground mb-1">{booking.service_title || booking.service?.title || 'Service'}</p>
                <div className="flex items-center space-x-4 text-sm text-muted-foreground">
                  <div className="flex items-center space-x-1">
                    <Icon name="Calendar" size={14} />
                    <span>{new Date(booking.booking_date || booking.bookingDate).toLocaleDateString()}</span>
                  </div>
                  {(booking.start_time || booking.startTime) && (
                    <div className="flex items-center space-x-1">
                      <Icon name="Clock" size={14} />
                      <span>{booking.start_time || booking.startTime}</span>
                    </div>
                  )}
                  <div className="flex items-center space-x-1">
                    <Icon name="Users" size={14} />
                    <span>{booking.participants} participant(s)</span>
                  </div>
                </div>
                {(booking.special_requests || booking.specialRequests) && (
                  <div className="mt-2 text-sm">
                    <p className="font-medium text-foreground">Special Requests:</p>
                    <p className="text-muted-foreground">{booking.special_requests || booking.specialRequests}</p>
                  </div>
                )}
              </div>
              <div className="text-right">
                <p className="text-lg font-bold text-primary">TZS {(booking.total_price || booking.totalAmount || 0).toLocaleString()}</p>
                <p className="text-sm text-muted-foreground">Total Amount</p>
                <p className="text-xs text-muted-foreground mt-1">
                  Payment: {booking.payment_status || booking.paymentStatus || 'pending'}
                </p>
              </div>
            </div>

            {/* Customer Contact Info */}
            <div className="flex items-center space-x-6 mb-4 text-sm text-muted-foreground">
              <div className="flex items-center space-x-1">
                <Icon name="Mail" size={14} />
                <span>{booking.traveler_email || booking.traveler?.email || 'N/A'}</span>
              </div>
              <div className="flex items-center space-x-1">
                <Icon name="Phone" size={14} />
                <span>{booking.traveler_phone || booking.traveler?.phone || 'N/A'}</span>
              </div>
              <div className="flex items-center space-x-1 text-xs">
                <Icon name="Clock" size={12} />
                <span>Received: {new Date(booking.created_at || booking.createdAt).toLocaleString()}</span>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center justify-between pt-4 border-t border-border">
              <div className="flex items-center space-x-2">
                <Button variant="outline" size="sm" onClick={() => window.open(`mailto:${booking.customerEmail}`)}>
                  <Icon name="MessageCircle" size={14} />
                  Message
                </Button>
                <Button variant="outline" size="sm" onClick={() => window.open(`tel:${booking.customerPhone}`)}>
                  <Icon name="Phone" size={14} />
                  Call
                </Button>
                <Button variant="outline" size="sm" onClick={() => {
                  const detailsWindow = window.open('', '_blank', 'width=600,height=400');
                  detailsWindow.document.write(`
                    <html>
                      <head><title>Booking Details - ${booking.customerName}</title></head>
                      <body style="font-family: Arial, sans-serif; padding: 20px;">
                        <h2>Booking Details</h2>
                        <p><strong>Customer:</strong> ${booking.customerName}</p>
                        <p><strong>Service:</strong> ${booking.service}</p>
                        <p><strong>Date:</strong> ${booking.date}</p>
                        <p><strong>Time:</strong> ${booking.time}</p>
                        <p><strong>Guests:</strong> ${booking.guests}</p>
                        <p><strong>Amount:</strong> $${booking.amount}</p>
                        <p><strong>Status:</strong> ${booking.status}</p>
                        <p><strong>Email:</strong> ${booking.customerEmail}</p>
                        <p><strong>Phone:</strong> ${booking.customerPhone}</p>
                      </body>
                    </html>
                  `);
                }}>
                  <Icon name="Eye" size={14} />
                  View Details
                </Button>
              </div>
              
              <div className="flex items-center space-x-2">
                {booking.status === 'pending' && (
                  <>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleBookingAction(booking.id, 'cancelled');
                      }}
                      className="text-red-600 hover:text-red-700"
                    >
                      <Icon name="X" size={14} />
                      Reject Pre-Order
                    </Button>
                    <Button 
                      variant="default" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleBookingAction(booking.id, 'confirmed');
                      }}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      <Icon name="Check" size={14} />
                      Accept Pre-Order
                    </Button>
                  </>
                )}
                
                {booking.status === 'confirmed' && (
                  <>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleBookingAction(booking.id, 'cancelled');
                      }}
                      className="text-red-600 hover:text-red-700"
                    >
                      <Icon name="X" size={14} />
                      Cancel Order
                    </Button>
                    <Button 
                      variant="default" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleBookingAction(booking.id, 'completed');
                      }}
                    >
                      <Icon name="CheckCircle" size={14} />
                      Mark as Completed
                    </Button>
                  </>
                )}
                
                {booking.status === 'completed' && (
                  <>
                    <div className="text-sm text-green-600 font-medium">
                      <Icon name="CheckCircle" size={14} className="inline mr-1" />
                      Service Completed
                    </div>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleDeleteBooking(booking.id);
                      }}
                      className="text-red-600 hover:text-red-700 hover:bg-red-50"
                    >
                      <Icon name="Trash2" size={14} />
                      Delete
                    </Button>
                  </>
                )}
                
                {booking.status === 'cancelled' && (
                  <>
                    <div className="text-sm text-red-600 font-medium">
                      <Icon name="XCircle" size={14} className="inline mr-1" />
                      Pre-Order Rejected
                    </div>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handleDeleteBooking(booking.id);
                      }}
                      className="text-red-600 hover:text-red-700 hover:bg-red-50"
                    >
                      <Icon name="Trash2" size={14} />
                      Delete
                    </Button>
                  </>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {!loading && currentBookings.length === 0 && (
        <div className="text-center py-12 bg-muted/20 rounded-lg border-2 border-dashed border-border">
          <Icon name="Calendar" size={48} className="text-muted-foreground mx-auto mb-4" />
          <h3 className="font-medium text-foreground mb-2">No {activeBookingTab} pre-orders</h3>
          <p className="text-muted-foreground">
            {activeBookingTab === 'pending' 
              ? 'New pre-order requests from travelers will appear here'
              : `No ${activeBookingTab} pre-orders found`
            }
          </p>
        </div>
      )}
    </div>
  );
};

export default BookingManagement;
