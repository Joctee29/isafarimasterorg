<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Location Filtering - iSafari</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-left: 4px solid #10b981;
            border-radius: 4px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #10b981;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            background: #f3f4f6;
            border-radius: 4px;
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .warning {
            color: #f59e0b;
            font-weight: bold;
        }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Location Filtering Test Page</h1>
        <p>Test the provider filtering logic with different location combinations</p>

        <div class="test-section">
            <h2>Test Scenarios</h2>
            <button onclick="testScenario1()">Test 1: Mbeya ‚Üí Mbeya Urban ‚Üí Mbeya CBD</button>
            <button onclick="testScenario2()">Test 2: Mbeya ‚Üí Mbeya Urban</button>
            <button onclick="testScenario3()">Test 3: Mbeya (Region only)</button>
            <button onclick="testScenario4()">Test 4: Mbeya ‚Üí Accommodation</button>
            <button onclick="testScenario5()">Test 5: Arusha ‚Üí Tours & Activities</button>
            <button onclick="testAllServices()">Show All Services</button>
        </div>

        <div class="test-section">
            <h2>Results</h2>
            <div id="results" class="results">
                <p style="color: #6b7280;">Click a test button above to see results...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://isafarinetworkglobal-2.onrender.com/api';
        
        const normalize = (str) => (str || '').toLowerCase().trim();
        
        async function fetchServices() {
            const response = await fetch(`${API_URL}/services?limit=500`);
            const data = await response.json();
            if (data.success) {
                return data.services;
            }
            return [];
        }
        
        function filterServices(services, location, categories = []) {
            const searchRegion = normalize(location.region);
            const searchDistrict = normalize(location.district);
            const searchArea = normalize(location.ward);
            
            return services.filter(service => {
                const serviceRegion = normalize(service.region);
                const serviceDistrict = normalize(service.district);
                const serviceArea = normalize(service.area);
                
                // Region filter
                if (searchRegion && serviceRegion !== searchRegion) return false;
                
                // District filter (try both district and area fields)
                if (searchDistrict) {
                    const districtMatchesDistrict = serviceDistrict === searchDistrict;
                    const districtMatchesArea = serviceArea === searchDistrict;
                    const isRegionLevel = !serviceDistrict && !serviceArea;
                    if (!districtMatchesDistrict && !districtMatchesArea && !isRegionLevel) return false;
                }
                
                // Area filter
                if (searchArea) {
                    const areaMatch = serviceArea === searchArea;
                    const districtLevel = !serviceArea && (serviceDistrict === searchDistrict || serviceDistrict === searchArea);
                    const regionLevel = !serviceArea && !serviceDistrict;
                    if (!areaMatch && !districtLevel && !regionLevel) return false;
                }
                
                // Category filter
                if (categories.length > 0) {
                    const serviceCategory = normalize(service.category);
                    if (!categories.map(normalize).includes(serviceCategory)) return false;
                }
                
                return true;
            });
        }
        
        function groupByProvider(services) {
            const map = new Map();
            services.forEach(service => {
                if (!service.provider_id) return;
                if (!map.has(service.provider_id)) {
                    map.set(service.provider_id, {
                        id: service.provider_id,
                        name: service.business_name || 'Unknown',
                        services: []
                    });
                }
                map.get(service.provider_id).services.push(service);
            });
            return Array.from(map.values());
        }
        
        async function runTest(location, categories, testName) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p style="color: #6b7280;">Loading...</p>';
            
            try {
                const services = await fetchServices();
                const filtered = filterServices(services, location, categories);
                const providers = groupByProvider(filtered);
                
                let html = `<h3>${testName}</h3>`;
                html += `<p><strong>Search Criteria:</strong></p>`;
                html += `<pre>${JSON.stringify(location, null, 2)}</pre>`;
                if (categories.length > 0) {
                    html += `<p><strong>Categories:</strong> ${categories.join(', ')}</p>`;
                }
                html += `<p class="${filtered.length > 0 ? 'success' : 'error'}">`;
                html += `Found ${providers.length} provider(s) with ${filtered.length} service(s)</p>`;
                
                if (providers.length > 0) {
                    html += '<div style="margin-top: 20px;">';
                    providers.forEach(provider => {
                        html += `<div class="result-item">`;
                        html += `<strong>${provider.name}</strong> (${provider.services.length} services)<br>`;
                        provider.services.forEach(s => {
                            html += `<small style="margin-left: 20px;">`;
                            html += `‚Ä¢ ${s.title} - ${s.category}<br>`;
                            html += `&nbsp;&nbsp;Location: ${s.region} ‚Üí ${s.district || 'N/A'} ‚Üí ${s.area || 'N/A'}`;
                            html += `</small><br>`;
                        });
                        html += `</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="error">‚ùå No providers found!</p>';
                    html += '<p class="warning">This might be a bug. Check console for details.</p>';
                }
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                console.error(error);
            }
        }
        
        function testScenario1() {
            runTest(
                { region: 'Mbeya', district: 'Mbeya Urban', ward: 'Mbeya CBD' },
                [],
                'Test 1: Mbeya ‚Üí Mbeya Urban ‚Üí Mbeya CBD'
            );
        }
        
        function testScenario2() {
            runTest(
                { region: 'Mbeya', district: 'Mbeya Urban', ward: '' },
                [],
                'Test 2: Mbeya ‚Üí Mbeya Urban'
            );
        }
        
        function testScenario3() {
            runTest(
                { region: 'Mbeya', district: '', ward: '' },
                [],
                'Test 3: Mbeya (Region only)'
            );
        }
        
        function testScenario4() {
            runTest(
                { region: 'Mbeya', district: '', ward: '' },
                ['Accommodation'],
                'Test 4: Mbeya + Accommodation'
            );
        }
        
        function testScenario5() {
            runTest(
                { region: 'Arusha', district: '', ward: '' },
                ['Tours & Activities'],
                'Test 5: Arusha + Tours & Activities'
            );
        }
        
        async function testAllServices() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p style="color: #6b7280;">Loading...</p>';
            
            try {
                const services = await fetchServices();
                let html = `<h3>All Services (${services.length} total)</h3>`;
                
                const byRegion = {};
                services.forEach(s => {
                    const region = s.region || 'Unknown';
                    if (!byRegion[region]) byRegion[region] = [];
                    byRegion[region].push(s);
                });
                
                Object.keys(byRegion).sort().forEach(region => {
                    html += `<div class="result-item">`;
                    html += `<strong>${region}</strong> (${byRegion[region].length} services)<br>`;
                    byRegion[region].forEach(s => {
                        html += `<small style="margin-left: 20px;">`;
                        html += `‚Ä¢ ${s.title} - ${s.category}<br>`;
                        html += `&nbsp;&nbsp;${s.district || 'N/A'} ‚Üí ${s.area || 'N/A'}`;
                        html += `</small><br>`;
                    });
                    html += `</div>`;
                });
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>