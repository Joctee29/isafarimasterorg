<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Database Features - iSafari Global</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2563eb; margin-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
        .section { margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 8px; }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #1d4ed8; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        button.success { background: #16a34a; }
        button.success:hover { background: #15803d; }
        .output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 12px;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        input, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 5px;
            font-size: 14px;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Database Features</h1>
        <p>Test Cart, Favorites, and Trip Plans database functionality</p>
        
        <div class="warning">
            ‚ö†Ô∏è <strong>Important:</strong> You must be logged in to test these features. 
            <button onclick="window.location.href='http://localhost:4028/login'">Go to Login</button>
        </div>

        <h2>1Ô∏è‚É£ Authentication Status</h2>
        <div class="section">
            <button onclick="checkAuth()">Check Authentication</button>
            <div id="auth-output" class="output"></div>
        </div>

        <h2>2Ô∏è‚É£ Cart Features</h2>
        <div class="section">
            <div class="grid">
                <div>
                    <h3>Get Cart</h3>
                    <button onclick="getCart()">Load Cart</button>
                </div>
                <div>
                    <h3>Add to Cart</h3>
                    <input type="number" id="cart-service-id" placeholder="Service ID" value="1">
                    <button onclick="addToCart()">Add Service</button>
                </div>
                <div>
                    <h3>Clear Cart</h3>
                    <button class="danger" onclick="clearCart()">Clear All Items</button>
                </div>
            </div>
            <div id="cart-output" class="output"></div>
        </div>

        <h2>3Ô∏è‚É£ Favorites Features</h2>
        <div class="section">
            <div class="grid">
                <div>
                    <h3>Get Favorites</h3>
                    <button onclick="getFavorites()">Load Favorites</button>
                </div>
                <div>
                    <h3>Add to Favorites</h3>
                    <input type="number" id="fav-provider-id" placeholder="Provider ID" value="1">
                    <button onclick="addToFavorites()">Add Provider</button>
                </div>
                <div>
                    <h3>Clear Favorites</h3>
                    <button class="danger" onclick="clearFavorites()">Clear All</button>
                </div>
            </div>
            <div id="favorites-output" class="output"></div>
        </div>

        <h2>4Ô∏è‚É£ Trip Plans Features</h2>
        <div class="section">
            <div class="grid">
                <div>
                    <h3>Get Trip Plans</h3>
                    <button onclick="getTripPlans()">Load Plans</button>
                </div>
                <div>
                    <h3>Add to Trip Plan</h3>
                    <input type="number" id="plan-service-id" placeholder="Service ID" value="1">
                    <input type="date" id="plan-date" placeholder="Plan Date">
                    <button onclick="addToTripPlan()">Add Service</button>
                </div>
                <div>
                    <h3>Clear Trip Plans</h3>
                    <button class="danger" onclick="clearTripPlans()">Clear All</button>
                </div>
            </div>
            <div id="plans-output" class="output"></div>
        </div>

        <h2>5Ô∏è‚É£ Run All Tests</h2>
        <div class="section">
            <button class="success" onclick="runAllTests()">üöÄ Run Complete Test Suite</button>
            <div id="all-tests-output" class="output"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        
        function log(output, message, type = 'info') {
            const outputEl = document.getElementById(output);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üì°';
            outputEl.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            outputEl.scrollTop = outputEl.scrollHeight;
        }

        function getAuthToken() {
            const user = JSON.parse(localStorage.getItem('isafari_user') || '{}');
            return user.token;
        }

        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            const url = `${API_URL}${endpoint}`;
            
            const config = {
                method: options.method || 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { Authorization: `Bearer ${token}` }),
                    ...options.headers,
                },
                ...(options.body && { body: JSON.stringify(options.body) }),
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Authentication
        async function checkAuth() {
            log('auth-output', 'Checking authentication...', 'info');
            const token = getAuthToken();
            
            if (!token) {
                log('auth-output', 'Not authenticated - no token found', 'error');
                return false;
            }
            
            log('auth-output', `Token found: ${token.substring(0, 20)}...`, 'success');
            
            const result = await apiCall('/auth/verify');
            if (result.success) {
                log('auth-output', `Authenticated as: ${JSON.stringify(result.data.user, null, 2)}`, 'success');
                return true;
            } else {
                log('auth-output', `Authentication failed: ${result.data?.message || 'Unknown error'}`, 'error');
                return false;
            }
        }

        // Cart Functions
        async function getCart() {
            log('cart-output', 'Loading cart...', 'info');
            const result = await apiCall('/cart');
            if (result.success) {
                log('cart-output', `Cart loaded successfully: ${result.data.total} items`, 'success');
                log('cart-output', JSON.stringify(result.data.cartItems, null, 2), 'success');
            } else {
                log('cart-output', `Failed to load cart: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function addToCart() {
            const serviceId = document.getElementById('cart-service-id').value;
            log('cart-output', `Adding service ${serviceId} to cart...`, 'info');
            
            const result = await apiCall('/cart/add', {
                method: 'POST',
                body: { serviceId: parseInt(serviceId), quantity: 1 }
            });
            
            if (result.success) {
                log('cart-output', `Service added successfully!`, 'success');
                log('cart-output', JSON.stringify(result.data, null, 2), 'success');
                await getCart(); // Reload cart
            } else {
                log('cart-output', `Failed to add to cart: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function clearCart() {
            log('cart-output', 'Clearing cart...', 'info');
            const result = await apiCall('/cart', { method: 'DELETE' });
            if (result.success) {
                log('cart-output', 'Cart cleared successfully!', 'success');
                await getCart(); // Reload cart
            } else {
                log('cart-output', `Failed to clear cart: ${result.data?.message || result.error}`, 'error');
            }
        }

        // Favorites Functions
        async function getFavorites() {
            log('favorites-output', 'Loading favorites...', 'info');
            const result = await apiCall('/favorites');
            if (result.success) {
                log('favorites-output', `Favorites loaded: ${result.data.total} providers`, 'success');
                log('favorites-output', JSON.stringify(result.data.favorites, null, 2), 'success');
            } else {
                log('favorites-output', `Failed to load favorites: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function addToFavorites() {
            const providerId = document.getElementById('fav-provider-id').value;
            log('favorites-output', `Adding provider ${providerId} to favorites...`, 'info');
            
            const result = await apiCall('/favorites/add', {
                method: 'POST',
                body: { providerId: parseInt(providerId) }
            });
            
            if (result.success) {
                log('favorites-output', `Provider added successfully!`, 'success');
                await getFavorites(); // Reload favorites
            } else {
                log('favorites-output', `Failed to add to favorites: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function clearFavorites() {
            log('favorites-output', 'Clearing favorites...', 'info');
            const result = await apiCall('/favorites', { method: 'DELETE' });
            if (result.success) {
                log('favorites-output', 'Favorites cleared successfully!', 'success');
                await getFavorites(); // Reload favorites
            } else {
                log('favorites-output', `Failed to clear favorites: ${result.data?.message || result.error}`, 'error');
            }
        }

        // Trip Plans Functions
        async function getTripPlans() {
            log('plans-output', 'Loading trip plans...', 'info');
            const result = await apiCall('/plans');
            if (result.success) {
                log('plans-output', `Trip plans loaded: ${result.data.total} services`, 'success');
                log('plans-output', JSON.stringify(result.data.plans, null, 2), 'success');
            } else {
                log('plans-output', `Failed to load plans: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function addToTripPlan() {
            const serviceId = document.getElementById('plan-service-id').value;
            const planDate = document.getElementById('plan-date').value;
            log('plans-output', `Adding service ${serviceId} to trip plan...`, 'info');
            
            const result = await apiCall('/plans/add', {
                method: 'POST',
                body: { 
                    serviceId: parseInt(serviceId),
                    planDate: planDate || null,
                    notes: 'Added via test page'
                }
            });
            
            if (result.success) {
                log('plans-output', `Service added to trip plan!`, 'success');
                await getTripPlans(); // Reload plans
            } else {
                log('plans-output', `Failed to add to plan: ${result.data?.message || result.error}`, 'error');
            }
        }

        async function clearTripPlans() {
            log('plans-output', 'Clearing trip plans...', 'info');
            const result = await apiCall('/plans', { method: 'DELETE' });
            if (result.success) {
                log('plans-output', 'Trip plans cleared successfully!', 'success');
                await getTripPlans(); // Reload plans
            } else {
                log('plans-output', `Failed to clear plans: ${result.data?.message || result.error}`, 'error');
            }
        }

        // Run all tests
        async function runAllTests() {
            const output = 'all-tests-output';
            document.getElementById(output).innerHTML = '';
            
            log(output, '========================================', 'info');
            log(output, 'üöÄ Starting Complete Test Suite', 'info');
            log(output, '========================================', 'info');
            
            // 1. Check Auth
            log(output, '\n1Ô∏è‚É£ Testing Authentication...', 'info');
            const isAuth = await checkAuthTest(output);
            if (!isAuth) {
                log(output, '\n‚ùå Tests cannot continue without authentication', 'error');
                return;
            }
            
            // 2. Test Cart
            log(output, '\n2Ô∏è‚É£ Testing Cart Features...', 'info');
            await testCart(output);
            
            // 3. Test Favorites
            log(output, '\n3Ô∏è‚É£ Testing Favorites Features...', 'info');
            await testFavorites(output);
            
            // 4. Test Trip Plans
            log(output, '\n4Ô∏è‚É£ Testing Trip Plans Features...', 'info');
            await testTripPlans(output);
            
            log(output, '\n========================================', 'info');
            log(output, '‚úÖ All Tests Completed!', 'success');
            log(output, '========================================', 'info');
        }

        async function checkAuthTest(output) {
            const token = getAuthToken();
            if (!token) {
                log(output, '‚ùå Not authenticated', 'error');
                return false;
            }
            const result = await apiCall('/auth/verify');
            if (result.success) {
                log(output, `‚úÖ Authenticated as: ${result.data.user.email}`, 'success');
                return true;
            }
            log(output, '‚ùå Authentication verification failed', 'error');
            return false;
        }

        async function testCart(output) {
            // Get cart
            let result = await apiCall('/cart');
            log(output, result.success ? `‚úÖ Get cart: ${result.data.total} items` : '‚ùå Failed to get cart', result.success ? 'success' : 'error');
            
            // Add to cart
            result = await apiCall('/cart/add', {
                method: 'POST',
                body: { serviceId: 1, quantity: 1 }
            });
            log(output, result.success ? '‚úÖ Add to cart successful' : '‚ùå Failed to add to cart', result.success ? 'success' : 'error');
        }

        async function testFavorites(output) {
            // Get favorites
            let result = await apiCall('/favorites');
            log(output, result.success ? `‚úÖ Get favorites: ${result.data.total} providers` : '‚ùå Failed to get favorites', result.success ? 'success' : 'error');
            
            // Add to favorites
            result = await apiCall('/favorites/add', {
                method: 'POST',
                body: { providerId: 1 }
            });
            log(output, result.success ? '‚úÖ Add to favorites successful' : '‚ùå Failed to add to favorites', result.success ? 'success' : 'error');
        }

        async function testTripPlans(output) {
            // Get plans
            let result = await apiCall('/plans');
            log(output, result.success ? `‚úÖ Get trip plans: ${result.data.total} services` : '‚ùå Failed to get plans', result.success ? 'success' : 'error');
            
            // Add to plan
            result = await apiCall('/plans/add', {
                method: 'POST',
                body: { serviceId: 1, planDate: null, notes: 'Test' }
            });
            log(output, result.success ? '‚úÖ Add to trip plan successful' : '‚ùå Failed to add to plan', result.success ? 'success' : 'error');
        }

        // Auto-check auth on load
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>